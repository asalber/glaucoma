---
title: "Análisis de los anillos neuroretinianos"
date: "`r Sys.Date()`"
---

```{r knitr_init, echo=F}
library(knitr)
library(rmarkdown)
# Global options
options(digits = 4)
opts_chunk$set(echo=F, cache=T, prompt=F, tidy=T, comment=NA, message=F, warning=F, dev="png", dev.args=list(type="cairo"), dpi=300)
```

```{r carga-paquetes, results='hide'}
# Carga de paquetes
.packages <- c("tidyverse", "GGally", "FactoMineR", "factoextra", "gridExtra", "gridExtra", "ggpubr", "kableExtra", "psych")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, library, character.only=T)
```

```{r carga-datos}
source("data-rims-loading.R")
```

# Estadística Descriptiva

```{r}
# Funciones para dibujar distribuciones por grupos
# Histogramas según glaucoma y ojos
overHist <- function(i){
  p <- ggplot(df, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5) + facet_grid(Ojo~.)
  return(p)
}

# Densidad según glaucoma y ojos 
overDensity <- function(i){
  p <- ggplot(df, aes_string(x = i)) + geom_density(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5) + facet_grid(Ojo~.)
  return(p)
}

# Diagrama de cajas según glaucoma y ojos
overBoxplot <- function(i){
  p <- ggplot(df, aes_string(x="Ojo", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
```


## FoBMO.Angle, Displacement y BMO.Area
### Ojo izquierdo
```{r tabla-descriptivos-fobmoangle-displacement-bmoarea-ojo-izdo}
result <- describeBy(df.L[,c("FoBMO.Angle", "Displacement", "BMO.Area")], df.L$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos del ángulo con la fóbea, desplazamiento y área del BMO en ojos izquierdos") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

### Ojo derecho
```{r tabla-descriptivos-fobmoangle-displacement-bmoarea-ojo-dcho}
result <- describeBy(df.R[,c("FoBMO.Angle", "Displacement", "BMO.Area")], df.R$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos del ángulo con la fóbea, desplazamiento y área del BMO en ojos derechos") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r histogramas-fobmoangle-displacement-bmoarea, fig.cap="Distribuciones del ángulo con la fóbea, desplazamiento y área según glaucoma."}
p <- lapply(c("FoBMO.Angle", "Displacement", "BMO.Area"), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r cajas-fobmoangle-displacement-bmoarea, fig.cap="Diagramas de caja del ángulo con la fóbea, desplazamiento y área según glaucoma."}
p <- lapply(c("FoBMO.Angle", "Displacement", "BMO.Area"), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```



```{r}
# Alternative
# stats <- list(media = ~ mean(.x, na.rm = T), std.dev = ~ sd(.x, na.rm = T))
# df.L %>% 
#   group_by(Glaucoma) %>%
#   summarise(across(FoBMO.Angle:BMO.Area, stats))
```

## BMO
### Ojo izquierdo

```{r tabla-descriptivos-bmo-ojo-izdo}
result <- describeBy(df.L[, varBMO], df.L$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del BMO de los ojos izquierdos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-bmo-ojo-izdo, fig.cap="Correlaciones entre los sectores del BMO de los ojos izquierdos según glaucoma."}
ggpairs(df.L[,c("Glaucoma",varBMO)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  varBMO)
```

Se observan correlaciones fuertes entre todos los sectores tanto de ojos sanos como de enfermos.

### Ojo derecho
```{r tabla-descriptivos-bmo-ojo-dcho}
result <- describeBy(df.R[,varBMO], df.R$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del BMO de los ojos derechos según glaucoma.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-bmo-ojo-dcho, fig.cap="Correlaciones entre los sectores del BMO de los ojos derechos según glaucoma."}
ggpairs(df.R[,c("Glaucoma",varBMO)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  varBMO)
```

Se observan correlaciones fuertes entre todos los sectores tanto de ojos sanos como de enfermos.

### Comparación de distribuciones por glaucoma y ojo
```{r histograma-bmo, fig.cap="Distribución del grosor de los sectores del BMO según glaucoma y ojo."}
p <- lapply(colnames(df[,varBMO]), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r cajas-bmo, fig.cap="Diagramas de caja del grosor de los sectores del BMO según glaucoma y ojo."}
p <- lapply(colnames(df[,varBMO]), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

Se aprecian distribuciones similares en los ojos izquierdos y derechos tanto de pacientes sanos como enfermos.

## Anillo 3.5
### Ojo izquierdo
```{r tabla-descriptivos-3.5-ojo-izdo}
result <- describeBy(df.L[,var3.5], df.L$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del anillo 3.5 de los ojos izquierdos según glaucoma.") %>%
  kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-3.5-ojo-izdo, fig.cap="Correlaciones entre los sectores del anillo 3.5 de los ojos izquierdos según glaucoma."}
ggpairs(df.L[,c("Glaucoma",var3.5)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var3.5)
```

Se observan correlaciones moderadas entre todos los sectores de los ojos enfermos y más débiles en los ojos sanos.
Las correlaciones son menores que en el anillo BMO, aunque podría ser debido a la existencia de bastantes datos atípicos.

### Ojo derecho
```{r tabla-descriptivos-3.5-ojo-dcho}
result <- describeBy(df.R[,var3.5], df.R$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del anillo 3.5 de los ojos derechos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-3.5-ojo-dcho, fig.cap="Correlaciones entre los sectores del BMO de los ojos derechos según glaucoma."}
ggpairs(df.R[,c("Glaucoma",var3.5)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var3.5)
```

Se observan correlaciones moderadas entre todos los sectores de los ojos enfermos, excepto entre el sector temporal y los sectores nasal y nasal inferior, y más débiles en los ojos sanos.
Las correlaciones son menores que en el anillo BMO, aunque podría ser debido a la existencia de bastantes datos atípicos.

### Comparación de distribuciones por glaucoma y ojo
```{r histogramas-3.5, fig.cap="Distribución del grosor de los sectores del anillo 3.5 según glaucoma y ojo."}
p <- lapply(colnames(df[,var3.5]), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r cajas-3.5, fig.cap="Diagramas de caja del grosor de los sectores del anillo 3.5 según glaucoma y ojo."}
p <- lapply(colnames(df[,var3.5]), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

Se aprecian distribuciones similares en los ojos izquierdos y derechos tanto de pacientes sanos como enfermos.

## Anillo 4.1
### Ojo izquierdo
```{r tabla-descriptivos-4.1-ojo-izdo}
result <- describeBy(df.L[,var4.1], df.L$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del anillo 4.1 de los ojos izquierdos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-4.1-ojo-izdo, fig.cap="Correlaciones entre los sectores del anillo 4.1 de los ojos izquierdos según glaucoma."}
ggpairs(df.L[,c("Glaucoma",var4.1)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var4.1)
```

Se observan correlaciones de moderadas a fuertes entre todos los sectores de los ojos enfermos y más débiles en los ojos sanos.
Las correlaciones son menores que en el anillo BMO y similares a las del anillo 3.5.

### Ojo derecho
```{r tabla-descriptivos-4.1-ojo-dcho}
result <- describeBy(df.R[,var4.1], df.R$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del anillo 4.1 de los ojos derechos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-4.1-ojo-dcho, fig.cap="Correlaciones entre los sectores del anillo 4.1 de los ojos derechos según glaucoma."}
ggpairs(df.R[,c("Glaucoma",var4.1)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var4.1)
```

Se observan correlaciones de moderadas a fuertes entre todos los sectores de los ojos enfermos, excepto en el temporal con los sectores nasales, y más débiles en los ojos sanos.
Las correlaciones son menores que en el anillo BMO y que en el 3.5, aunque podría ser debido a la existencia de datos atípicos.

### Comparación de distribuciones por glaucoma y ojo
```{r histogramas-4.1, fig.cap="Distribución del grosor de los sectores del anillo 4.1 según glaucoma y ojo."}
p <- lapply(colnames(df[,var4.1]), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r cajas-4.1, fig.cap="Diagramas de caja del grosor de los sectores del anillo 4.1 según glaucoma y ojo."}
p <- lapply(colnames(df[,var4.1]), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

Se aprecian distribuciones similares en los ojos izquierdos y derechos tanto de pacientes sanos como enfermos.

## Anillo 4.7
### Ojo izquierdo
```{r tabla-descriptivos-4.7-ojo-izdo}
result <- describeBy(df.L[,var4.7], df.L$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% kable(caption = "Estadísticos descriptivos de los sectores del anillo 4.7 de los ojos izquierdos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-4.7-ojo-izdo, fig.cap="Correlaciones entre los sectores del anillo 4.7 de os ojos izquierdos según glaucoma."}
ggpairs(df.L[,c("Glaucoma",var4.7)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var4.7)
```

Se observan correlaciones de moderadas a fuertes entre todos los sectores de los ojos enfermos, y más débiles o casi nulas en los ojos sanos.
Las correlaciones son menores que en el anillo BMO pero mayores que en los anillos 3.5 y 4.1.

### Ojo derecho
```{r tabla-descriptivos-4.7-ojo-dcho}
result <- describeBy(df.R[,var4.7], df.R$Glaucoma, mat = T, digits = 4)
result[,c("item","vars","trimmed", "mad","range","se")] <- NULL
colnames(result)[1] <- "Glaucoma"
result %>% 
  kable(caption = "Estadísticos descriptivos de los sectores del anillo 4.7 de los ojos derechos según glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

```{r grafico-descriptivo-4.7-ojo-dcho, fig.cap="Correlaciones entre los sectores del anillo 4.7 de los ojos derechos según glaucoma."}
ggpairs(df.R[,c("Glaucoma",var4.7)], mapping=aes(color=Glaucoma, alpha=0.5), columns =  var4.7)
```

Se observan correlaciones de moderadas a fuertes entre todos los sectores de los ojos enfermos, excepto en el temporal con los sectores nasales, y más débiles o casi nulas en los ojos sanos.
Las correlaciones son menores que en el anillo BMO similares a los anillos 3.5 y 4.1, aunque podría ser debido a la existencia de datos atípicos.

### Comparación de distribuciones por glaucoma y ojo
```{r histogramas-4.7, fig.cap="Distribución del grosor de los sectores del anillo 4.7 según glaucoma y ojo."}
p <- lapply(colnames(df[,var4.7]), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r cajas-4.7, fig.cap="Diagramas de caja del grosor de los sectores del anillo 4.7 según glaucoma y ojo."}
p <- lapply(colnames(df[,var4.7]), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

Se aprecian distribuciones similares en los ojos izquierdos y derechos tanto de pacientes sanos como enfermos.

# Comparación de medias y proporciones
## Sexo

```{r comparacion-proporciones-sexo}
x <- factor(df$Glaucoma, levels(df$Glaucoma)[c(2,1)])
y <- df$Sexo
result <- unlist(prop.test(table(x,y))[c("estimate","conf.int", "p.value")])
result$difference <- result[["estimate.prop 1"]]-result[["estimate.prop 2"]]
result <- result[c(1,2,6,3,4,5)]
result <- data.frame(result)
colnames(result) <- c("Proporción.Mujeres", "Proporción.Hombres","Diferencia.proporciones", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result %>% 
  kable(caption="Contraste de comparación de la proporción de mujeres y hombres con glaucoma") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

## Ojo

```{r comparacion-proporciones-ojos}
result <- unlist(mcnemar.test(table(df$Glaucoma, df$Ojo))[c("statistic", "p.value")])
result <- data.frame(t(result))
colnames(result) <- c("Estadístico de McNemar", "p-valor")
result %>% kable(caption = "Contraste de comparación de la proporción de ojos izquierdo y derechos con glaucoma.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

Existe relación estadísticamente significativa entre el glaucoma y los ojos, es decir, los ojos izquierdo y derecho no son independientes.

## Edad 

```{r comparacion-medias-edad}
result <- data.frame(t(sapply(df[c("Edad")], function(x) 
     unlist(t.test(x~df$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result %>% 
  kable(caption = "Contraste de comparación de las edades medias en sanos y enfermos.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas entre las edades medias de los pacientes sanos y los pacientes con glaucoma. La edad media de los pacientes con glaucoma es entre `r -result$lim.sup.int.conf` y `r -result$lim.inf.int.conf` años mayor que la de los sanos. 

```{r comparacion-medias-edad-sexo-glaucoma}
result <- data.frame(t(unlist(t.test(Edad~Sexo, data=df[df$Glaucoma=="Y",])[c("estimate","conf.int", "p.value")])))
result$difference <- result$estimate.mean.in.group.M-result$estimate.mean.in.group.H
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Hombres", "Media.Mujeres","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result %>% 
  kable(caption = "Contraste de comparación de las edades medias de mujeres y hombres con glaucoma.") %>%
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas entre las edades medias de hombres y mujeres. La edad media de las mujeres con glaucoma es entre `r result$lim.inf.int.conf` y `r result$lim.sup.int.conf` años mayor que la de los hombres.


## Area BMO

### Ojo izquierdo

```{r comparacion-medias-area-BMO-ojo-izdo}
result <- data.frame(t(unlist(t.test(BMO.Area~Glaucoma, data=df.L)[c("estimate","conf.int", "p.value")])))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result %>% 
  kable(caption = "Contraste de comparación de las medias del área de BMO en ojos izquierdos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

No existen diferencias estadísticamente significativas en el area media del anillo BMO de ojos izquierdos sanos y enfermos.

### Ojo derecho

```{r comparacion-medias-area-BMO-ojo-dcho}
result <- data.frame(t(unlist(t.test(BMO.Area~Glaucoma, data=df.R)[c("estimate","conf.int", "p.value")])))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result %>% 
  kable(caption = "Contraste de comparación de las medias del área de BMO en ojos derechos de sanos y enfermos.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

No existen diferencias estadísticamente significativas en el area media del anillo BMO de ojos derechos sanos y enfermos.

## BMO
Comparación de las medias de los sectores del BMO en ojos sanos y enfermos.

### Ojo izquierdo

```{r comparacion-medias-bmo-ojo-izdo}
result.L <- data.frame(t(sapply(df.L[,varBMO], function(x) unlist(t.test(x~df.L$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.L$difference <- result.L$estimate.mean.in.group.N-result.L$estimate.mean.in.group.Y
result.L <- result.L[c(1,2,6,3,4,5)]
colnames(result.L) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.L <- mutate(result.L, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.L %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del BMO en ojos izquierdos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos izquierdos sanos y enfermos de todos los sectores del anillo BMO.

### Ojo derecho

```{r comparacion-medias-bmo-ojo-dcho}
result.R <- data.frame(t(sapply(df.R[,varBMO], function(x) unlist(t.test(x~df.R$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.R$difference <- result.R$estimate.mean.in.group.N-result.R$estimate.mean.in.group.Y
result.R <- result.R[c(1,2,6,3,4,5)]
colnames(result.R) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.R <- mutate(result.R, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.R %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del BMO en ojos derechos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos derechos sanos y enfermos de todos los sectores del anillo BMO.

```{r intervalos-confianza-comparacion-medias-bmo, fig.cap= "Intervalos de confianza del 95% para la diferencia de medias del grosor de los sectores del BMO de sanos y enfermos según ojo."}
result.L$Sector <- row.names(result.L)
result.L$Eye <- "L"
result.R$Sector <- row.names(result.R)
result.R$Eye <- "R"
result <- rbind(result.L, result.R)
ggplot(result, aes(x = Sector, y = Diferencia.medias, colour=Eye)) + 
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), position = position_dodge(width = 0.5), width=.2) +
  geom_point(size = 2, position = position_dodge(0.5)) 
```

Como se puede apreciar todos los intervalos se solapan, lo que indica que no hay diferencias estadísticamente significativas entre los ojos.

## Anillo 3.5
Comparación de las medias de los sectores del anillo 3.5 en ojos sanos y enfermos.

### Ojo izquierdo
```{r comparacion-medias-3.5-ojo-izdo}
result.L <- data.frame(t(sapply(df.L[,var3.5], function(x) unlist(t.test(x~df.L$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.L$difference <- result.L$estimate.mean.in.group.N-result.L$estimate.mean.in.group.Y
result.L <- result.L[c(1,2,6,3,4,5)]
colnames(result.L) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.L <- mutate(result.L, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.L %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 3.5 en ojos izquierdos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos izquierdos sanos y enfermos de todos los sectores del anillo 3.5.

### Ojo derecho
```{r comparacion-medias-3.5-ojo-dcho}
result.R <- data.frame(t(sapply(df.R[,var3.5], function(x) unlist(t.test(x~df.R$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.R$difference <- result.R$estimate.mean.in.group.N-result.R$estimate.mean.in.group.Y
result.R <- result.R[c(1,2,6,3,4,5)]
colnames(result.R) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.R <- mutate(result.R, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.R %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 3.5 en ojos derechos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos derechos sanos y enfermos de todos los sectores del anillo 3.5.

```{r intervalos-confianza-comparacion-medias-3.5, fig.cap= "Intervalos de confianza del 95% para la diferencia de medias del grosor de los sectores del anillo 3.5 de sanos y enfermos según ojo."}
result.L$Sector <- row.names(result.L)
result.L$Eye <- "L"
result.R$Sector <- row.names(result.R)
result.R$Eye <- "R"
result <- rbind(result.L, result.R)
ggplot(result, aes(x = Sector, y = Diferencia.medias, colour=Eye)) + 
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), position = position_dodge(width = 0.5), width=.2) +
  geom_point(size = 2, position = position_dodge(0.5)) 
```

Como se puede apreciar todos los intervalos se solapan, lo que indica que no hay diferencias estadísticamente significativas entre los ojos.

## Anillo 4.1
Comparación de las medias de los sectores del anillo 4.1 en ojos sanos y enfermos.

### Ojo izquierdo
```{r comparacion-medias-4.1-ojo-izdo}
result.L <- data.frame(t(sapply(df.L[,var4.1], function(x) unlist(t.test(x~df.L$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.L$difference <- result.L$estimate.mean.in.group.N-result.L$estimate.mean.in.group.Y
result.L <- result.L[c(1,2,6,3,4,5)]
colnames(result.L) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.L <- mutate(result.L, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.L %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 4.1 en ojos izquierdos de sanos y enfermos.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos izquierdos sanos y enfermos de todos los sectores del anillo 4.1.

### Ojo derecho
```{r comparacion-medias-4.1-ojo-dcho}
result.R <- data.frame(t(sapply(df.R[,var4.1], function(x) unlist(t.test(x~df.R$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.R$difference <- result.R$estimate.mean.in.group.N-result.R$estimate.mean.in.group.Y
result.R <- result.R[c(1,2,6,3,4,5)]
colnames(result.R) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.R <- mutate(result.R, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.R %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 4.1 en ojos derechos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos derechos sanos y enfermos de todos los sectores del anillo 4.1.

```{r intervalos-confianza-comparacion-medias-4.1, fig.cap= "Intervalos de confianza del 95% para la diferencia de medias del grosor de los sectores de anillo 4.1 de sanos y enfermos según ojo."}
result.L$Sector <- row.names(result.L)
result.L$Eye <- "L"
result.R$Sector <- row.names(result.R)
result.R$Eye <- "R"
result <- rbind(result.L, result.R)
ggplot(result, aes(x = Sector, y = Diferencia.medias, colour=Eye)) + 
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), position = position_dodge(width = 0.5), width=.2) +
  geom_point(size = 2, position = position_dodge(0.5)) 
```

Como se puede apreciar todos los intervalos se solapan, lo que indica que no hay diferencias estadísticamente significativas entre los ojos.

## Anillo 4.7
Comparación de las medias de los sectores del anillo 4.7 en ojos sanos y enfermos.

### Ojo izquierdo
```{r comparacion-medias-4.7-ojo-izdo}
result.L <- data.frame(t(sapply(df.L[,var4.7], function(x) unlist(t.test(x~df.L$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.L$difference <- result.L$estimate.mean.in.group.N-result.L$estimate.mean.in.group.Y
result.L <- result.L[c(1,2,6,3,4,5)]
colnames(result.L) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.L <- mutate(result.L, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.L %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 4.7 en ojos izquierdos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
# datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos izquierdos sanos y enfermos de todos los sectores del anillo 4.7.

### Ojo derecho
```{r comparacion-medias-4.7-ojo-dcho}
result.R <- data.frame(t(sapply(df.R[,var4.7], function(x) unlist(t.test(x~df.R$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result.R$difference <- result.R$estimate.mean.in.group.N-result.R$estimate.mean.in.group.Y
result.R <- result.R[c(1,2,6,3,4,5)]
colnames(result.R) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result.R <- mutate(result.R, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result.R %>% 
  kable(caption = "Contraste de comparación de las medias de los sectores del anillo 4.7 en ojos derechos de sanos y enfermos.") %>% 
  kable_styling(bootstrap_options = "hover", full_width = F)
```

Existen diferencias estadísticamente muy significativas en el grosor medio de ojos derechos sanos y enfermos de todos los sectores del anillo 4.7.

```{r intervalos-confianza-comparacion-medias-4.7, fig.cap= "Intervalos de confianza del 95% para la diferencia de medias del grosor de los sectores del anillo 4.7 de sanos y enfermos según ojo."}
result.L$Sector <- row.names(result.L)
result.L$Eye <- "L"
result.R$Sector <- row.names(result.R)
result.R$Eye <- "R"
result <- rbind(result.L, result.R)
ggplot(result, aes(x = Sector, y = Diferencia.medias, colour=Eye)) + 
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), position = position_dodge(width = 0.5), width=.2) +
  geom_point(size = 2, position = position_dodge(0.5)) 
```

Como se puede apreciar todos los intervalos se solapan, lo que indica que no hay diferencias estadísticamente significativas entre los ojos.

Se obsevan diferencias muy significativas entre las medias del grosor de todos los anillos de pacientes sanos y con glaucoma. Las diferencias más significativas se dan en el BMO, pero las diferencias mayores se dan en el anillo 3.5. Por sectores las diferencias más significaivas se dan en el BMO global y nasal superior, y las mayores en el anillo 3.5 global y temporal inferior. 

# Comparación de ojos
Comparación de las medias del ojo izquierdo y derecho para cada sector. 

```{r comparacion-medias-ojos}
# Comparación de medias de los ojos izquierdo y derecho en cada sector.
df.tidy <- df %>%
  select(all_of(c("Measurement.Id", "Glaucoma", "Ojo", varRims))) %>%
  pivot_wider(names_from = Ojo, names_sep = ".", values_from = all_of(varRims)) %>%
  drop_na()

fun <- function(i) {
  unlist(t.test(unlist(df.tidy[, i]), unlist(df.tidy[, i+1]), paired = T)[c("estimate","conf.int", "p.value")])
}

result <- data.frame(t(sapply(seq(3, 58, 2), fun)))

fun <- function(i) {
  paste(colnames(df.tidy)[i], "-", colnames(df.tidy)[i+1])
}
rownames(result) <- sapply(seq(3, 58, 2), fun)
colnames(result) <- c("Media.diferencia", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
result <- mutate(result, `p-valor` = format.pval(`p-valor`, eps = .001, digits = 2))
result %>% 
  kable(caption = "Contraste de comparación de las medias de los ojos izquierdos y derechos para los distintos sectores.") %>% kable_styling(bootstrap_options = "hover", full_width = F)
```


```{r intervalos-confianza-comparacion-medias-ojos, fig.cap="Intervalos de confianza del 95% para la diferencia de medias entre los ojos izquieros y derechos para los distintos sectores."}
result$Sector <- c("BMO.G", "BMO.NS", "BMO.N", "BMO.NI", "BMO.TI", "BMO.T", "BMO.TS", 
                   "Rim.3.5.G", "Rim.3.5.NS", "Rim.3.5.N", "Rim.3.5.NI", "Rim.3.5.TI", "Rim.3.5.T", "Rim.3.5.TS", 
                   "Rim.4.1.G", "Rim.4.1.NS", "Rim.4.1.N", "Rim.4.1.NI", "Rim.4.1.TI", "Rim.4.1.T", "Rim.4.1.TS",
                   "Rim.4.7.G", "Rim.4.7.NS", "Rim.4.7.N", "Rim.4.7.NI", "Rim.4.7.TI", "Rim.4.7.T", "Rim.4.7.TS")
ggplot(result, aes(x = Sector, y = Media.diferencia)) + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), col="red", width=.2) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

En general se aprecian diferencias significativas entre las medias del grosor de los sectores de los ojos izquierdo y derecho en algunos sectores como el Nasal Superior, y no tan claras en otros.
No obstante, se ha observado clínicamente que aparentemente no hay relación entre el estado de los dos ojos, por lo que se han cosiderado los ojos de cada paciente como individuos independientes en el estudio. 

# Análisis de componentes principales

Dada la gran correlación entre todos los sectores del BMO y los anillos neuroretinianos se realizó un análisis de componentes principales para reducir la dimensionalidad de los datos y ver qué combinaciones de variables explicaban la mayor parte de la variabilidad de los datos.

```{r principal-components-explained-variability, fig.cap= "Porcentaje de la variabilidad total explicada por cada componente principal."}
# Principal components healthy and glaucoma eyes
result.pca <- PCA(df.L[, c(varRims)], scale.unit = F, graph=F)
# eigenvalues <- get_eigenvalue(result.pca)
# Explained variability by principal components
fviz_eig(result.pca,
  main = "Variabilidad explicada por los componentes principales",
  ylab = "% de la variabilidad total",
  xlab = "Componentes princiaples (dimensiones)") +
  theme(plot.title = element_text(hjust = 0.5))
# ggsave("img/explained-variability-principal-components.pdf", width = 7, height = 5)
```
El análisis de componentes principales muestra que el primer componente principal explica casi el 60% de la variabilidad total, mientras que el segundo solo explica el 11%. 

```{r principal-components-correlation, fig.cap= "Correlación de los sectores del BMO y los anillos neuroretinianos con el primer componente principal."}
# Correlation of variables with first principal component
fviz_cos2(result.pca, 
  choice = "var", 
  axes=1, 
  title="Correlación de las variables con el primer componente principal",
  ) + 
  ylab("Coeficiente de determinación r²") +
  theme(plot.title = element_text(hjust = 0.5))
#ggsave("img/correlation-pca.pdf", width = 7, height = 5)
```
Los sectores más correlacionados con el primer componente principal son el global (G) y el temporal inferior (TI) de los anillos neuroretinianos y el BMO.
 
```{r principal-components-contribution, fig.cap= "Contribución de los sectores del BMO y los anillos neuroretinianos a los dos primeros componentes principales."}
# Contribution of variables to first principal component
p1 <- fviz_contrib(result.pca, choice="var", axes=1, top = 10, title="Contribución de las variables\n al primer componente principal") +
  theme(plot.title = element_text(hjust = 0.5))
#ggsave("img/contribution-variables-pca-dim1.pdf", width = 7, height = 5)

# Contribution of variables to second principal component
p2 <- fviz_contrib(result.pca, choice="var", axes=2, top = 10, title="Contribución de las variables al\n segundo componente principal") +
  theme(plot.title = element_text(hjust = 0.5))
#ggsave("img/contribution-variables-pca-dim2.pdf", width = 7, height = 5)
grid.arrange(p1, p2, nrow = 1)
```
Las variables que más cotribuyen al valor del primer componente principal son los sectores globales de los anillos 3.5, 4.1 y 4.7 y los sectores temporales inferiores de los anillos 3.5, 4.1 y 4.7, seguidos del sector global del BMO, el sector temporal superior del anillo 4.7, el sector temporal superior del anillo 4.1 y el sector temporal inferior del BMO.

```{r map-eyes-principal-components, fig.cap="Mapa de ojos sanos (N) y glaucomatosos (Y) sobre los dos primeros componentes principales."}
palette <- c("#00FF00", "#FF0000")
# Plot eyes on the two first principal components
fviz_pca_ind(
  result.pca,
  geom = c("point"),
  axes = c(1, 2),
  habillage = df.L$Glaucoma,
  palette = palette,
  ddEllipses = T,
  ellipse.type = "t",
  title = "Mapa de ojos sanos y glaucomatosos sobre los dos primeros componentes principales"
) +
  theme(legend.position = "top", plot.title = element_text(hjust = 0.5))
# ggsave("img/pca-map.pdf", width = 7, height = 5)
```
El mapa muestra una clara separación, con una pequeña región de solapamiento, entre ojos sanos y glaucomatosos a lo largo del primer componente principal, mientras que no se observa separación a lo largo del segundo componente principal.




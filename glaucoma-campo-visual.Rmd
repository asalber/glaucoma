---
title: "Análisis de concordancia entre las clasificaciones del glaucoma según los anillos retinianos y según el campo visual"
date: "`r Sys.Date()`"
---

```{r knitr-init, echo=F}
library(knitr)
## Global options
options(digits = 4)
opts_chunk$set(echo=F, cache=T, prompt=F, tidy=T, comment=NA, message=F, warning=F, dev="png", dev.args=list(type="cairo"), dpi=300)
```

```{r packages, results='hide'}
.packages <- c("tidyverse", "irr")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, require, character.only=T)
```

```{r data-loading, results='hide'}
data <- read_csv('datos/campo-visual.csv', col_types = cols(Estadio = "f"))
data$Estadio <- ordered(data$Estadio, levels=levels(data$Estadio))                 
```

```{r data-filtering, results='hide'}
data <- data %>%  # Elminar los casos sin datos en la variable Dm
  filter(!is.na(Dm)) %>% # Eliminar los casos con errores mayores del 16%
  filter(ERROR <= 16)
```

# Objetivo

Este estudio pretende comprobar si existe concordancia entre la clasificación de los ojos en los estadíos de glaucoma definidos a partir de los anillos retinianos (ver http://aprendeconalf.es/glaucoma/glaucoma-clusters-izdo.html) y la clasifiación clásica a partir de campo visual. 

# Análisis del campo visual

## Diagrama de cajas del campo vistual según estadíos de glaucoma

```{r distribution}
# Color palette
  n <- 4
  colfunc <- colorRampPalette(c("#FD8D3C", "#800026"))
  palette <- colfunc(n)
  palette.healthy <- c("#00BFC4", palette)
#palette.healthy <- c("#00FF00", "#3FBF00", "#7F7F00", "#BF3F00", "#FF0000")
#palette <- palette.healthy[-1]

data %>% 
  ggplot(aes(x=Dm, fill=Estadio)) +
  geom_boxplot() +
  scale_fill_manual(values = palette) + 
  labs(title = "Diagrama de cajas del campo visual según estadíos de glaucoma") +
  theme(plot.title = element_text(hjust = 0.5))
```

## Intervalos de confianza para la media del campo visual según estadíos de glaucoma

```{r confidence-intervals-glaucoma-stages}
means <- data %>% 
  group_by(Estadio) %>%
  summarise(n=n(), media = mean(Dm), desv.est= sd(Dm)) %>%
  mutate(error.est = desv.est / sqrt(n), lim.inf.ic = media - qt(1 - (0.05 / 2), n - 1) * error.est, lim.sup.ic = media + qt(1 - (0.05 / 2), n - 1) * error.est)
kable(means)
```

```{r confidence-intervals-plot}
# Color palette
ggplot(means, aes(x=Estadio, y = media, colour = Estadio, shape = Estadio)) +
  geom_pointrange(aes(ymin = lim.inf.ic, ymax = lim.sup.ic), position = position_dodge(width = 0.5)) +
  ggtitle("Intervalos de confianza para la media del campo visual según estadíos de glaucoma") +
  scale_colour_manual(values = palette) +
  theme(plot.title = element_text(hjust = 0.5))
```
Como se puede apreciar, existe una separación clara entre los intervalos de confianza para la media del campo visual de los estadíos de glaucoma excepto para los dos primeros estadíos que se solapan.

<!-- Añadir ANOVA -->

## Definición de estadíos a partir del campo visual

Definimos a partir del campo visual 4 estadíos al igual que se hizo con los anillos retinianos.

```{r k-means-clusters}
seed = 123
# Variables consideradas
vars = "Dm"
# Número de clusters
n <- 4
labels <- c("I", "II", "III", "IV")
# Shapes
shapes <- c(1, 3, 15, 17, 16)
# K-means clusters
clusters <- kmeans(data[, vars], centers = n, nstart = 25)
centers <- clusters$centers[order(clusters$centers[,1], decreasing = T),]
clusters <- kmeans(data[, vars], centers = centers)
# Convert the cluster into a factor
clusters$cluster <- as.factor(clusters$cluster)
# Assign labels to factors
levels(clusters$cluster) <- labels
# Add cluster to data frame
data[, "Estadio.CV"] <- ordered(clusters$cluster)
# data %>% ggplot(aes(x=Dm, y=Estadio.CV, colour=Estadio.CV)) + geom_point()
```

```{r confidence-intervals-visual-field-stages}
means <- data %>% 
  group_by(Estadio.CV) %>%
  summarise(n=n(), media = mean(Dm), desv.est= sd(Dm)) %>%
  mutate(error.est = desv.est / sqrt(n), lim.inf.ic = media - qt(1 - (0.05 / 2), n - 1) * error.est, lim.sup.ic = media + qt(1 - (0.05 / 2), n - 1) * error.est)
kable(means)
```

## Análisis de concordancia

Calculamos el coeficiente de concordancia de Kendall para comprobar si los estadíos definidos a partir de los anillos retinianos concuerdan con los definidos a partir del campo visual.

```{r Kendalls-coefficient}
kendall(data[, c("Estadio", "Estadio.CV")], correct = T)
```
Se puede concluir que existe una concordancia fuerte ($W=0.831$) y muy significativa ($p<0.01$) entre ambos rankings de clasficación del glaucoma.

      

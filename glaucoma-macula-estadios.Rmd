---
title: "Clasifiación del Glaucoma en estadíos a partir del cubo macular"
date: "`r Sys.Date()`"
---

```{r setup, include=F, cache = F, echo = F}
require("knitr")
## Global options
options(digits = 4)
opts_chunk$set(echo = F, cache = T, prompt = F, tidy = T, comment = NA, message = F, warning = F, dev = "svg")
```

```{r carga-paquetes, results='hide'}
.packages <- c("tidyverse", "tensorflow", "keras")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, require, character.only=T)
Sys.setenv(RETICULATE_PYTHON="/usr/bin/python")
```

```{r carga-datos}
# Carga de la base de datos (ver fichero glaucoma-preprocesamiento-datos.r)
load("data/data-macula-preprocesed.RData")
df <- df.macula %>%
  # Filter left eyes
  filter(Ojo == "L") %>%
  # Remove FULL layer
  filter(Capa == "RNFL")

# Conjunto de variables
varCells <- NULL
for (i in 1:8){
  for (j in 1:8){
    varCells <- c(varCells, paste0("Celda",j,".",i))
  }
}

# Eliminación datos atípicos
removeOutliers <- function(x) {
  qnt <- quantile(x, probs=c(.25, .75, 0.05, 0.95), na.rm = T)
  iqr <- qnt[2]-qnt[1]
  fence1 <- qnt[1]-1.5*iqr
  fence2 <- qnt[2]+1.5*iqr
  x[x < fence1] <- qnt[3]
  x[x > fence2] <- qnt[4]
  return(x)
}

df[df$Glaucoma=="Y" & df$Capa=="RNFL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="RNFL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="RNFL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="RNFL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="GCL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="GCL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="GCL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="GCL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="INL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="INL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="INL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="INL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="IPL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="IPL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="IPL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="IPL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="OPL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="OPL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="OPL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="OPL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="ONL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="ONL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="ONL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="ONL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="PRL", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="PRL", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="PRL", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="PRL", varCells], removeOutliers)
df[df$Glaucoma=="Y" & df$Capa=="RPE", varCells] <- sapply(df[df$Glaucoma=="Y" & df$Capa=="RPE", varCells], removeOutliers)
df[df$Glaucoma=="N" & df$Capa=="RPE", varCells ] <- sapply(df[df$Glaucoma=="N" & df$Capa=="RPE", varCells], removeOutliers)

# Arrange cells of the same eye in the same row
df.wide <- df %>% 
  # Convert to long format
  pivot_longer(-c(Glaucoma, Ojo, Capa, Id), names_to = "cell") %>%
  # Join the layer and cell columns
  unite(temp, Capa, cell, sep = ".") %>%
  # Come back to wide format
  pivot_wider(names_from = temp, values_from = value)
  
# Añadir capa OPL+ONL
# dfOPLONL <- cbind(df[df$Capa=="OPL", 1:4], df[df$Capa=="OPL", varCells] + df[df$Capa=="ONL", varCells])
# dfOPLONL$Capa <- "OPL+ONL" 
# df <- rbind(df, dfOPLONL)

df.wide <- df
# Cargar conjunto datos con estadios
df.stages <- read_csv("data/data-stages.csv") %>% 
  select(-c(Ojo, Glaucoma))
# Añadir estadios al conjunto de datos de la mácula
df <- inner_join(df.wide, df.stages, by="Id") %>%
  # Mover la columna del Estadio al principio
  select(Id, Sexo, Edad, Glaucoma, Ojo, Estadio, everything())

# Look for rows with more than 64 NA
rows <- NULL
for (i in 1:nrow(df)){
  if (sum(is.na(df[i,])) > 10) {
    rows <- append(rows, i)
  }
}
# Remove rows from the data frame
df <- df %>% slice(-rows)
# Replace NAs by the column mean
col_means <- lapply(df %>% select(-c(Id, Sexo, Edad, Glaucoma, Ojo, Estadio)), mean, na.rm = TRUE)
df <- df %>% replace_na(col_means)
```

```{r prepare-input-layer}
# Rename the stage levels to numbers
df$Estadio <- recode_factor(df$Estadio, "Sano"=0, "I"=1, "II"=2, "III"=3, "IV"=4)

df <- df %>% 
  # Remove non numeric variables
  select(-c(Id, Sexo, Edad, Glaucoma, Ojo, Capa)) %>%
  # Convert state to numeric
  mutate(Estadio = as.numeric(Estadio)-1)

# Turn data frame into a matrix
df <- as.matrix(df)

# Set `dimnames` to `NULL`
dimnames(df) <- NULL

# Split data set into features and labels
# Features
x <- df[,2:ncol(df)] 
# Labels
y <- df[,1]
# Normalize features to 0-1 scale
x <- x / max(x)

# Semilla
set.seed(123)

# Determine sample size
ind <- sample(2, nrow(df), replace=TRUE, prob=c(0.8, 0.2))

# Split the data into train and test.x
train.x <- x[ind == 1, ]
test.x <- x[ind == 2, ]
# Split the class attribute
train.y <- y[ind == 1]
test.y <- y[ind == 2]
# One hot encode target values
train.y <- to_categorical(train.y)
test.y.labels <- to_categorical(test.y)
```

# Resumen
En este trabajo se presenta un estudio de clasificación del Glaucoma en estadíos (Sano, I, II, III y IV) a partir de las capas de fibras nerviosas de la mácula mediante redes neuronales. Los estadíos se han generado mediante el algoritmo de K-medias ([más info](https://aprendeconalf.es/glaucoma/glaucoma-clusters-izdo.html)).

## Redes neuronales profundas
### Red neuronal con tres capas
#### Estructura de la red

```{r neural-net-model1}
# Initialize a sequential model
model <- keras_model_sequential() 

# Add layers to the model
model %>% 
  layer_dense(units = 48, activation = "relu", input_shape = c(ncol(train.x))) %>% 
  layer_dense(units = 24, activation = "relu") %>%
  layer_dense(units = 5, activation = "softmax")

summary(model)
```

#### Resumen del entrenamiento

```{r neural-net-model1-fit}
# Compile the model
model %>% compile(
  loss = 'categorical_crossentropy',
  optimizer = 'adam',
  metrics = 'accuracy'
)
# Fit the model
history <- model %>% fit(train.x, train.y, epochs = 50, verbose = 2, batch_size = 5, validation_split = 0.1)
# Plot fit history
plot(history)
# Save the model
save_model_tf(object = model, filepath = "macula-model")
```

#### Evaluación del modelo
```{r neural-net-model1-evaluation}
# Confusion matrix
predicciones <- model %>% predict_classes(test.x)
estadio <- test.y
table(estadio, predicciones)
# mean(test.y == predicciones)
# Evaluate the model
score <- model %>% evaluate(test.x, test.y.labels, verbose = 0)
```

**Error**: `r score[1]`
**Precisión**: `r score[2]`










---
title: "Clasificación mediante análsisi discriminante lineal (ojos izquierdos)"
date: "`r Sys.Date()`"
---

```{r setup, include=F, cache = F, echo = F}
require("knitr")
## Global options
options(digits = 4)
opts_chunk$set(echo = F, cache = T, prompt = F, tidy = T, comment = NA, message = F, warning = F, dev = "svg")
```

```{r carga-datos}
# Carga de la base de data preprocesados (ver fichero glaucoma-preprocesamiento-data.r)
source("codigo/carga-datos-anillos-estadios-izdo.R")
```

```{r carga-paquetes, results='hide'}
# Carga de paquetes
.packages <- c("pander", "reshape2", "MASS", "caret")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, require, character.only=T)
```

```{r seleccion-datos}
# Filtrado de ojos izquierdos
data %<>% filter(Ojo=="L")
# Conjunto de datos de ojos con glaucoma sin sanos
data.glaucoma <- droplevels(data[data$Estadio != "Sano", ])
```

# Análisis discriminante lineal

```{r classification-function}
classify <- function(data, vars){
  # Compute principal components
  # result.pca.glaucoma <- PCA(data[data$Stage!='Healthy', vars], scale.unit = F, graph=F, ncp = length(vars)) 
  result.pca <- prcomp(data[, vars], center = F, scale = F)
  # Add principal components coordinates to a data frame  
  #data.pca.glaucoma <- as.data.frame(result.pca.glaucoma$ind$coord)
  data.pca <- as.data.frame(result.pca$x)
  # Add cluster to principal components data frame
  data.pca$Estadio <- data$Estadio
  # Linear discriminant analysis (without healthy eyes)
  result.lda <- lda(Estadio~., data = data.pca, CV = T)
  # Model goodness
  performance <- confusionMatrix(result.lda$class, data.pca$Estadio)
  colnames(performance$byClass) <- c("Sensibilidad", "Especificidad", "VPP", "VPN", "Precisión", "Exhaustividad", "Medida.F", "Prevalencia", "Detection.Rate", "Detection.Prevalence", "Precisión.Global")
  rownames(performance$byClass) <- gsub("Class:", "Estadio", rownames(performance$byClass))
  performance$byClass <- performance$byClass[, c("Sensibilidad","Especificidad","Precisión.Global")]
  return(list(da = result.lda, performance = performance))
}
```

## Comparación de modelos

```{r model-comparison}
# Comparison of classification models with different variables
accuracy.table <- data.frame(vars=character(), accuracy1=double(), accuracy2=double())
# All the variables
vars <- "Todas las variables"
classification.glaucoma <- classify(data.glaucoma, vars = varRims)
classification <- classify(data, vars = varRims)
accuracy.table %<>% add_row(vars = vars, accuracy1 = classification.glaucoma$performance$overall[1], accuracy2 = classification$performance$overall[1])
# Clusters basados en todos los sectores globales y temporales inferiores
vars <- "Sectores G y TI del BMO y todos los anillos"
classification.glaucoma <- classify(data.glaucoma, vars=c(varG, varTI))
classification <- classify(data, vars=c(varG, varTI))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en todos los sectores globales
vars <- "Sectores G del BMO y todos los anillos"
classification.glaucoma <- classify(data.glaucoma, vars=varG)
classification <- classify(data, vars=varG)
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en todos los sectores temporales inferiores
vars <- "Sectores TI del BMO y todos los anillos"
classification.glaucoma <- classify(data.glaucoma, vars=varTI)
classification <- classify(data, vars=varTI)
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior de losa Rims BMO y 3.5
vars <- "Sectores G y TI del BMO y anillo 3.5"
classification.glaucoma <- classify(data.glaucoma, vars=c("AnilloBMO.G", "AnilloBMO.TI", "Anillo3.5.G", "Anillo3.5.TI"))
classification <- classify(data, vars=c("AnilloBMO.G", "AnilloBMO.TI", "Anillo3.5.G", "Anillo3.5.TI"))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior del Rim BMO
vars <- "Sectores G y TI del BMO"
classification.glaucoma <- classify(data.glaucoma, vars=c("AnilloBMO.G", "AnilloBMO.TI"))
classification <- classify(data, vars=c("AnilloBMO.G", "AnilloBMO.TI"))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior del Rim 3.5
vars <- "Sectores G y TI del anillo 3.5"
classification.glaucoma <- classify(data.glaucoma, vars=c("Anillo3.5.G", "Anillo3.5.TI"))
classification <- classify(data, vars=c("Anillo3.5.G", "Anillo3.5.TI"))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global de los Rims BMO y 3.5
vars <- "Sectores G del BMO y el anillo 3.5"
classification.glaucoma <- classify(data.glaucoma, vars=c("AnilloBMO.G", "Anillo3.5.G"))
classification <- classify(data, vars=c("AnilloBMO.G", "Anillo3.5.G"))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores temporales inferiores de los Rims BMO y 3.5
vars <- "Sectores TI del BMO y el anillo 3.5"
classification.glaucoma <- classify(data.glaucoma, vars=c("AnilloBMO.TI", "Anillo3.5.TI"))
classification <- classify(data, vars=c("AnilloBMO.TI", "Anillo3.5.TI"))
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector global del Rim BMO
vars <- "Sector G del BMO"
classification.glaucoma <- classify(data.glaucoma, vars="AnilloBMO.G")
classification <- classify(data, vars="AnilloBMO.G")
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector global del Rim 3.5
vars <- "Sector G del 3.5 rim"
classification.glaucoma <- classify(data.glaucoma, vars="Anillo3.5.G")
classification <- classify(data, vars="Anillo3.5.G")
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector temporal inferior del Rim BMO
vars <- "Sector TI del BMO"
classification.glaucoma <- classify(data.glaucoma, vars="AnilloBMO.TI")
classification <- classify(data, vars="AnilloBMO.TI")
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector temporal inferior del Rim 3.5
vars <- "Sector TI del anillo 3.5"
classification.glaucoma <- classify(data.glaucoma, vars="Anillo3.5.TI")
classification <- classify(data, vars="Anillo3.5.TI")
accuracy.table %<>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])

colnames(accuracy.table) <- c("Variables usadas en el modelo", "Precisión global<br> sin incluir ojos sanos", "Precisión global<br> incluyendo ojos sanos")
pander(accuracy.table, justify = c('left', 'right', 'right'),  split.cells = c(25, 1, 1))
```

## Modelo usando todas las variables

### Matriz de confusión sin incluir ojos sanos

```{r confusion-matrix-without-healthy-eyes}
classification.glaucoma <- classify(data.glaucoma, vars=varRims)
pander(classification.glaucoma$performance$table)
```

### Evaluación del modelo sin incluir ojos sanos

```{r performance-without-healthy-eyes}
pander(classification.glaucoma$performance$byClass, split.cells = 1)
```

### Matriz de confusión incluyendo ojos sanos

```{r confusion-matrix-with-healthy-eyes}
classification <- classify(data, vars=varRims)
pander(classification$performance$table)
```

### Evaluación del modelo incluyendo ojos sanos

```{r performance-with-healthy-eyes}
pander(classification$performance$byClass, split.cells = 1)
```

## Modelo usando los sectores G y TI del BMO y todos los anillos

### Matriz de confusión sin incluir ojos sanos

```{r confusion-matrix-without-healthy-eyes-G-TI}
classification.glaucoma <- classify(data.glaucoma, vars=c(varG, varTI))
pander(classification.glaucoma$performance$table)
```

### Evaluación del modelo sin incluir ojos sanos

```{r performance-without-healthy-eyes-G-TI}
pander(classification.glaucoma$performance$byClass, split.cells = 1)
```

### Matriz de confusión incluyendo ojos sanos

```{r confusion-matrix-with-healthy-eyes-G-TI}
classification <- classify(data, vars=c(varG, varTI))
pander(classification$performance$table)
```

### Evaluación del modelo incluyendo ojos sanos

```{r performance-with-healthy-eyes-G-TI}
pander(classification$performance$byClass, split.cells = 1)
```

## Modelo usando los sectores G y TI del BMO y el anillo 3.5

### Matriz de confusión sin incluir ojos sanos

```{r confusion-matrix-without-healthy-eyes-G-TI-BMO-3.5}
classification.glaucoma <- classify(data.glaucoma, vars=c("AnilloBMO.G", "AnilloBMO.TI", "Anillo3.5.G", "Anillo3.5.TI"))
pander(classification.glaucoma$performance$table)
```

### Evaluación del modelo sin incluir ojos sanos

```{r performance-without-healthy-eyes-G-TI-BMO-3.5}
pander(classification.glaucoma$performance$byClass, split.cells = 1)
```

### Matriz de confusión incluyendo ojos sanos

```{r confusion-matrix-with-healthy-eyes-G-TI-BMO-3.5}
classification <- classify(data, vars=c("AnilloBMO.G", "AnilloBMO.TI", "Anillo3.5.G", "Anillo3.5.TI"))
pander(classification$performance$table)
```

### Evaluación del modelo incluyendo ojos sanos

```{r performance-with-healthy-eyes-G-TI-BMO-3.5}
pander(classification$performance$byClass, split.cells = 1)
```




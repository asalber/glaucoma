---
title: "Clasificación mediante análisis discriminante lineal (ojos izquierdos)"
date: "`r Sys.Date()`"
---

```{r setup, include=F, cache = F, echo = F}
require("knitr")
## Global options
options(digits = 4)
opts_chunk$set(echo = F, cache = T, prompt = F, tidy = T, comment = NA, message = F, warning = F, dev = "svg")
```

```{r packages, results='hide'}
.packages <- c("MASS", "tidyverse", "FactoMineR", "caret", "kableExtra")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, require, character.only=T)
```

```{r data-loading, results='hide'}
# Data loading
df <- read_csv(file="data/data-rims-preprocesed-stages.csv", col_types = cols(Eye = "f", Glaucoma = "f", Stage = "f")) %>%
  # Reorder stage levels 
  mutate(Estadio = fct_relevel(Estadio, "Sano", "I", "II", "III", "IV"))
# Data without healthy eyes
df.glaucoma <- df %>%
  filter(Glaucoma == "Y") %>%
  # Remove unused stage levels
  mutate(Estadio = fct_drop(Estadio))

# Set of variables
varBMO <- startsWith(colnames(df),"BMO")
varBMO[11] <- F
varBMO <- colnames(df)[varBMO]
var3.5 <- startsWith(colnames(df),"RNFL3.5")
var3.5 <- colnames(df)[var3.5]
var4.1 <- startsWith(colnames(df),"RNFL4.1")
var4.1 <- colnames(df)[var4.1]
var4.7 <- startsWith(colnames(df),"RNFL4.7")
var4.7 <- colnames(df)[var4.7]
varG <- endsWith(colnames(df), ".G")
varG <- colnames(df[varG])
varTI <- endsWith(colnames(df), ".TI")
varTI <- colnames(df[varTI])
varT <- endsWith(colnames(df), ".T")
varT <- colnames(df[varT])
varTS <- endsWith(colnames(df), ".TS")
varTS <- colnames(df[varTS])
varNS <- endsWith(colnames(df), ".NS")
varNS <- colnames(df[varNS])
varN <- endsWith(colnames(df), ".N")
varN <- colnames(df[varN])
varNI <- endsWith(colnames(df), ".NI")
varNI <- colnames(df[varNI])
varRims <- c(varBMO, var3.5, var4.1, var4.7)
varSectors <- c(varG, varTI, varT, varTS, varNS, varN, varNI)
```

# Análisis discriminante lineal

```{r classification-function}
classify <- function(df, vars){
  # Compute principal components
  # result.pca.glaucoma <- PCA(df[df$Estadio!='Sano', vars], scale.unit = F, graph=F, ncp = length(vars)) 
  result.pca <- prcomp(df[, vars], center = F, scale = F)
  # Add principal components coordinates to a data frame  
  #df.pca.glaucoma <- as.data.frame(result.pca.glaucoma$ind$coord)
  df.pca <- as.data.frame(result.pca$x)
  # Add cluster to principal components data frame
  df.pca$Estadio <- df$Estadio
  # Linear discriminant analysis (without healthy eyes)
  result.lda <- lda(Estadio~., data=df.pca)
  result.eval <- lda(Estadio~., data=df.pca, CV=T)
  # Model goodness
  performance <- confusionMatrix(result.eval$class, df.pca$Estadio)
  colnames(performance$byClass) <- c("Sensibilidad", "Especificidad", "VPP", "VPN", "Precisión", "Exhaustividad", "Medida.F", "Prevalencia", "Detection.Rate", "Detection.Prevalence", "Precisión.Global")
  rownames(performance$byClass) <- gsub("Class:", "Estadio", rownames(performance$byClass))
  performance$byClass <- performance$byClass[, c("Sensibilidad","Especificidad","Precisión.Global")]
  return(list(pc = result.pca, da = result.lda, performance = performance))
}
```

```{r model-comparison}
# Comparison of classification models with different variables
accuracy.table <- data.frame(vars=character(), accuracy1=double(), accuracy2=double())
# All the variables
vars <- "Todas las variables"
classification.glaucoma <- classify(df.glaucoma, vars=varRims)
classification <- classify(df, vars=varRims)
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Todos los sectores globales y temporales inferiores
vars <- "Sectoress G y TI del BMO y todos los RNFL"
classification.glaucoma <- classify(df.glaucoma, vars=c(varG, varTI))
classification <- classify(df, vars=c(varG, varTI))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Sector G del BMO y todos los sectores globales y temporales inferiores del RNFL
vars <- "Sectores G del BMO y G y TI de todos los RNFL"
classification.glaucoma <- classify(df.glaucoma, vars=c(varG, "RNFL3.5.TI", "RNFL4.1.TI", "RNFL4.7.TI"))
classification <- classify(df, vars=c(varG, "RNFL3.5.TI", "RNFL4.1.TI", "RNFL4.7.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Sector G del BMO y todos los sectores globales y temporales inferiores del RNFL
vars <- "Sectores G del BMO y todos los RNFL y TI del RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c(varG, "RNFL3.5.TI"))
classification <- classify(df, vars=c(varG, "RNFL3.5.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Todos los sectores globales y temporales inferiores del RNFL
vars <- "Sectores G y TI de todos los RNFL"
classification.glaucoma <- classify(df.glaucoma, vars=c("RNFL3.5.G", "RNFL4.1.G", "RNFL4.7.G", "RNFL3.5.TI", "RNFL4.1.TI", "RNFL4.7.TI"))
classification <- classify(df, vars=c("RNFL3.5.G", "RNFL4.1.G", "RNFL4.7.G", "RNFL3.5.TI", "RNFL4.1.TI", "RNFL4.7.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Todos los sectores globales
vars <- "Sectores G del BMO y todos los RNFL"
classification.glaucoma <- classify(df.glaucoma, vars=varG)
classification <- classify(df, vars=varG)
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# Todos los sectores temporales inferiores
vars <- "Sectores TI del BMO y todos los RNFL"
classification.glaucoma <- classify(df.glaucoma, vars=varTI)
classification <- classify(df, vars=varTI)
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior del BMO y RNFL 3.5
vars <- "Sectores G y TI del BMO y el RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.G", "BMO.TI", "RNFL3.5.G", "RNFL3.5.TI"))
classification <- classify(df, vars=c("BMO.G", "BMO.TI", "RNFL3.5.G", "RNFL3.5.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global del BMO y global y temporal inferior del RNFL 3.5
vars <- "Sectores G del BMO y G y TI del RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.G", "RNFL3.5.G", "RNFL3.5.TI"))
classification <- classify(df, vars=c("BMO.G", "RNFL3.5.G", "RNFL3.5.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior del RNFL BMO
vars <- "Sectores G y TI del BMO"
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.G", "BMO.TI"))
classification <- classify(df, vars=c("BMO.G", "BMO.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global y temporal inferior del RNFL 3.5
vars <- "Sectores G y TI de RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c("RNFL3.5.G", "RNFL3.5.TI"))
classification <- classify(df, vars=c("RNFL3.5.G", "RNFL3.5.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores global de los RNFLs BMO y 3.5
vars <- "Sectores G del BMO y RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.G", "RNFL3.5.G"))
classification <- classify(df, vars=c("BMO.G", "RNFL3.5.G"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados en los sectores temporales inferiores de los RNFLs BMO y 3.5
vars <- "Sectores TI del BMO y RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.TI", "RNFL3.5.TI"))
classification <- classify(df, vars=c("BMO.TI", "RNFL3.5.TI"))
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector global del RNFL BMO
vars <- "Sector G del BMO"
classification.glaucoma <- classify(df.glaucoma, vars="BMO.G")
classification <- classify(df, vars="BMO.G")
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector global del RNFL 3.5
vars <- "Sector G del RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars="RNFL3.5.G")
classification <- classify(df, vars="RNFL3.5.G")
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector temporal inferior del RNFL BMO
vars <- "Sector TI del BMO"
classification.glaucoma <- classify(df.glaucoma, vars="BMO.TI")
classification <- classify(df, vars="BMO.TI")
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])
# classification basados el sector temporal inferior del RNFL 3.5
vars <- "Sector TI del RNFL 3.5"
classification.glaucoma <- classify(df.glaucoma, vars="RNFL3.5.TI")
classification <- classify(df, vars="RNFL3.5.TI")
accuracy.table <- accuracy.table %>% add_row(vars=vars, accuracy1=classification.glaucoma$performance$overall[1], accuracy2=classification$performance$overall[1])

colnames(accuracy.table) <- c("Variables usadas en el modelo", "Precisión global con ojos sanos", "Precisión global sin ojos sanos")
kbl(accuracy.table, caption = "Resumen de la precisión global de los modelos de clasificación mediante análisis discriminante lineal usando distintos conjuntos de variables.") %>% kable_styling(full_width = F)
```

## Modelo con todas las variables

### Matriz de confusión sin ojos sanos

```{r confusion-matrix-without-healthy-eyes}
classification.glaucoma <- classify(df.glaucoma, vars=varRims)
kbl(classification.glaucoma$performance$table, caption = "Matriz de confusión del modelo de clasifiación de análisis discriminante lineal que usa todas las variables sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

### Efectividad sin ojos sanos

```{r performance-without-healthy-eyes}
kbl(classification.glaucoma$performance$byClass, caption = "Sensibilidad y especificidad del modelo de clasificación de análisis discriminante lineal que usa todas las variables sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

### Matriz de confusión con ojos sanos

```{r confusion-matrix-with-healthy-eyes}
classification <- classify(df, vars=varRims)
kbl(classification$performance$table, caption = "Matriz de confusión del modelo de clasifiación de análisis discriminante lineal que usa todas las variables incluyendo ojos sanos.") %>% kable_styling(full_width = F)
```

### Efectividad con ojos sanos

```{r performance-with-healthy-eyes}
kbl(classification$performance$byClass, caption = "Sensibilidad y especificidad del modelo de clasificación de análisis discriminante lineal que usa todas las variables sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

## Modelo con los sectores G y TI del BMO y RNFL 3.5

### Funciones discriminates sin ojos sanos

Coeficientes de las funciones discriminantes lineales:

```{r discriminant-coeffitients-without-healthy-eyes-G-TI-BMO-3.5}
classification.glaucoma <- classify(df.glaucoma, vars=c("BMO.G", "BMO.TI", "RNFL3.5.G", "RNFL3.5.TI"))
kbl(classification.glaucoma$pc$rotation %*% classification.glaucoma$da$scaling, caption = "Coeficientes e las funciones discriminantes del modelo de clasificación por análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

### Matriz de confusión sin ojos sanos

```{r confusion-matrix-without-healthy-eyes-G-TI-BMO-3.5}
kbl(classification.glaucoma$performance$table, caption = "Matriz de confusión del modelo de clasifiación de análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

### Efectividad sin ojos sanos

```{r performance-without-healthy-eyes-G-TI-BMO-3.5}
kbl(classification.glaucoma$performance$byClass, caption = "Sensibilidad y especificidad del modelo de clasificación de análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 sin incluir ojos sanos.") %>% kable_styling(full_width = F)
```

### Funciones discriminantes con ojos sanos

Coeficientes de las funciones discriminantes lineales:

```{r discriminant-coeffitients-with-healthy-eyes-G-TI-BMO-3.5}
classification <- classify(df, vars=c("BMO.G", "BMO.TI", "RNFL3.5.G", "RNFL3.5.TI"))
kbl(classification$pc$rotation %*% classification$da$scaling, caption = "Coeficientes e las funciones discriminantes del modelo de clasificación por análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 incluyendo ojos sanos.") %>% kable_styling(full_width = F)
```

### Mariz de confusión con ojos sanos
  
```{r confusion-matrix-with-healthy-eyes-G-TI-BMO-3.5}
kbl(classification$performance$table, caption = "Matriz de confusión del modelo de clasifiación de análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 incluyendo ojos sanos.") %>% kable_styling(full_width = F)
```

### Efectividad con ojos sanos

```{r performance-with-healthy-eyes-G-TI-BMO-3.5}
kbl(classification$performance$byClass, caption = "Sensibilidad y especificidad del modelo de clasificación de análisis discriminante lineal que usa los sectores G y TI del BMO y el anillo 3.5 incluyendo ojos sanos.") %>% kable_styling(full_width = F)
```

### Estadísticos para la distribución de BMO.G, Rim3.5.G and Rim3.5.TI por Estadios
```{r confidence-intervals-means-clusters, fig.cap="Intervalos de confianza de 95% para el grosor medio de los sectores G y TI del BMO y el anillo 3.5 según estadios de glaucoma."}
# Means of variables by stages
# Convert data frame to long format
df.long <- df %>% 
  select(Estadio, BMO.G, BMO.TI, RNFL3.5.G, RNFL3.5.TI) %>% 
  pivot_longer(-Estadio, names_to = "Sector")

means <- df.long %>% group_by(Sector, Estadio) %>% 
  summarise(n = n(), mean = mean(value, na.rm = T), sd = sd(value, na.rm = T))  %>%
  mutate(se = sd/sqrt(n), lower.ci = mean-qt(1-(0.05/2), n-1)*se, upper.ci = mean+qt(1-(0.05/2), n-1)*se)
kbl(means) %>% kable_styling(full_width = F)

# Color palette
palette.healthy <- c("#00FF00", "#3FBF00", "#7F7F00", "#BF3F00", "#FF0000")
palette <- palette.healthy[-1]

# Plot of means by stages
ggplot(means, aes(x = Sector, y = mean, colour = Estadio, shape = Estadio)) +
  geom_pointrange(aes(ymin = lower.ci, ymax = upper.ci), position = position_dodge(width = 0.5)) +
  ggtitle("Intervalos de confianza para las medias de los sectores G y TI \n del BMO y el anillo 3.5 según estadios de glaucoma") +
  scale_colour_manual(values = palette.healthy) +
  ylab("Media") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), plot.title = element_text(hjust = 0.5))

ggsave("img/confidence-intervals-bmo-35-G-TI-stages.pdf", width = 14, height = 12, units = "cm")
```


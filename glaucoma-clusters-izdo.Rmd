---
title: "Definición de estadios de Glaucoma (ojos izquierdos)"
date: "`r Sys.Date()`"
---

```{r setup, include=F, cache = F, echo = F}
require("knitr")
## Global options
options(digits = 4)
opts_chunk$set(echo = F, cache = T, prompt = F, tidy = T, comment = NA, message = F, warning = F, dev = "svg")
```

```{r carga-datos}
# Carga de la base de data preprocesados (ver fichero glaucoma-preprocesamiento-data.r)
source("carga-datos-anillos.R")
```

```{r carga-paquetes, results='hide'}
# Carga de paquetes
.packages <- c("reshape2", "FactoMineR", "factoextra", "MASS", "caret", "GGally", "kableExtra")
.installed <- .packages %in% installed.packages()
if (length(.packages[!.installed])>0) install.packages(.packages[!.installed])
lapply(.packages, require, character.only=T)
```

# Objetivo

En este estudio se pretende definir distintos grupos de gravedad de glaucoma (estadíos de desarrollo de la enfermedad) en función del grosor de los anillos neuroretinianos, mediante la técnica de las $k$-medias.

# Correlación

```{r matriz-correlacion}
# Correlación entre todos los sectores de los anillos
ggcorr(data[, varSectors], hjust = 0.9, size = 3, layout.exp = 2, label = TRUE, label_size = 2, label_round = 2, low = "darkred", high = "#0072B2") +
  ggtitle("Matriz de correlación entre los sectores del BMO y de los anillos RFNL") +
  guides(fill = guide_colourbar(title="Coef. correlación\n Pearson r")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), plot.title = element_text(hjust = 0.5))
```

# Análisis de componentes principales

```{r componentes-principales}
# Análisis de componentes principales de sanos y enfermos
result.pca <- PCA(data[, c(varRims)], scale.unit = F, graph=F)
fviz_eig(result.pca, main = "Variabilidad explicada por las dimensiones de los componentes principales", ylab = "Porcentaje de la variabilidad explicada", xlab = "Dimensiones")
```

Se observa que la mayor parte de la variabilidad la explica la primera dimensión. Ello es debido a la alta correlación entre los sectores de los distintos anillos.

```{r componentes-principales-2}
var <- get_pca_var(result.pca)
fviz_pca_var(result.pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel=T, title="Coordenadas de las variables en los dos primeros componentes principales")
fviz_cos2(result.pca, choice = "var", axes=1, title="Correlación de cada variable con el primer componente principal") + ylab("Coef. Determinación r²")
```

Se observa que los sectores que más peso tienen en el primer componente principal son el global y el temporal inferior de todos los anillos. Estas variables son precisamente las más correlacionadas entre si tal y como se aprecia en el siguente gráfico.

# Estadios

```{r numero-clusters}
# Number of clusters
fviz_nbclust(data.glaucoma[, varRims], kmeans, method = "wss") + 
  xlab("Número de grupos") + 
  ylab("Suma de cuadrados intra-grupos") + 
  ggtitle("Reducción de la variabilidad intra-grupos según el número de grupos")
```

A la vista del gráfico se decide crear 4 grupos, ya que la reducción de la variabilidad intra-grupo a partir de 4 grupos no es significativa.

```{r k-means-clusters}
# K-means clusters
seed = 123
# Variables considered
vars = varRims
# Número de clusters
n = 4
labels <- c("I", "II", "III", "IV")
  # Color palette
  colfunc <- colorRampPalette(c("#FD8D3C", "#800026"))
  palette <- colfunc(n)
  palette.healthy <- c("#00BFC4", palette)
# Shapes
shapes <- c(1, 3, 15, 17, 16)
# k-means
# C <- chol( var(data[data$Glaucoma=="Y", vars]) )
# y <- as.matrix(data[data$Glaucoma=="Y", vars]) %*% solve(C)
# clusters <- kmeans(y, centers = n, nstart = 25)
# centers <- clusters$centers[order(clusters$centers[,1], decreasing = T),]
# clusters <- kmeans(y, centers = centers)

clusters <- kmeans(data[data$Glaucoma=="Y", vars], centers = n, nstart = 25)
centers <- clusters$centers[order(clusters$centers[,1], decreasing = T),]
clusters <- kmeans(data[data$Glaucoma=="Y", vars], centers = centers)
# Convert the cluster into a factor
clusters$cluster <- as.factor(clusters$cluster)
# Assign labels to factors
levels(clusters$cluster) <- labels
# Add cluster to data frame
data$Estadio <- factor("Sano", levels=c("Sano", labels))
data[data$Glaucoma=="Y", "Estadio"] <- clusters$cluster
```

## Mapa de los estadíos de glaucoma sin incluir ojos sanos

```{r map-clusters-whithout-healthy}
# Principal components
result.pca <- PCA(data[, vars], scale.unit = F, graph=F) 
# Map of clusters (without healthy eyes)
fviz_pca_ind(
  result.pca,
  geom = c("point"),
  axes = c(1, 2),
  select.ind = list(name = rownames(data[data$Glaucoma == "Y", ])),
  col.ind = data$Estadio,
  palette = palette,
  addEllipses = T,
  ellipse.type = "t",
  title = "Mapa de estadios deglaucoma sobre los dos primeros componentes principales",
  legend.title = "Estadio"
) +
  xlab("Primer componente principal") +
  ylab("Segundo componente principal") +
  scale_shape_manual(values = shapes[-1]) +
  #coord_flip(clip = "off") +
  theme(legend.position = "top", plot.title = element_text(hjust = 0.5))
#ggsave("img/map-clusters-whithout-healthy.pdf")
```

Como se puede apreciar en el gráfico, los cuatro estadios quedan separados bastante bien a lo largo del eje x que corresponde al primer componente principal.

## Mapa de estadíos de glaucoma incluyendo ojos sanos

```{r map-clusters-whith-healthy}
# Map of clusters (with healthy eyes)
fviz_pca_ind(
  result.pca,
  geom = c("point"),
  axes = c(1, 2),
  col.ind = data$Estadio,
  palette = palette.healthy,
  addEllipses = T,
  ellipse.type = "t",
  title = "Mapa de estadios de glaucoma sobre los dos primeros componentes principales",
  legend.title = "Estadio"
) +
  xlab("Primer componente principal") +
  ylab("Segundo componente principal") +
  scale_shape_manual(values = shapes) +
  theme(legend.position = "top", plot.title = element_text(hjust = 0.5))
#ggsave("img/map-clusters-with-healthy.pdf")
```


<!-- ### Estadísticos de la distribución de AnilloBMO.G, AnilloBMO.TI, Anillo3.5.G y Anillo3.5.TI por Estadios stages -->
<!-- ```{r confidence-intervals-means-clusters} -->
<!-- # Means of variables by stages -->
<!-- melted.data <- melt(data[, c("Estadio", vars=c("BMO.G", "BMO.TI", "RNFL3.5.G", "RNFL3.5.TI"))]) -->
<!-- colnames(melted.data)[2] <- "Sector"  -->
<!-- means <- melted.data %>% group_by(Sector, Estadio) %>%  -->
<!--   summarise(n = n(), mean = mean(value, na.rm = T), sd = sd(value, na.rm = T))  %>% -->
<!--   mutate(se = sd/sqrt(n), lower.ci = mean-qt(1-(0.05/2), n-1)*se, upper.ci = mean+qt(1-(0.05/2), n-1)*se) -->
<!-- means %>% kable() %>% kable_styling(bootstrap_options = "hover", full_width = F) -->

<!-- # Color palette -->
<!-- colfunc <- colorRampPalette(c("#FD8D3C", "#800026")) -->
<!-- palette <- colfunc(4) -->
<!-- palette.healthy <- c("#00BFC4", palette) -->

<!-- # Plot of means by stages -->
<!-- ggplot(means, aes(x = Sector, y = mean, colour = Estadio, shape = Estadio )) + -->
<!--   geom_pointrange(aes(ymin = lower.ci, ymax = upper.ci), position = position_dodge(width = 0.5)) + -->
<!--   ggtitle("Intervalos de confianza para las medias de los sectores G y TI\n del BMO y el anillo 3.5 por estadios de glaucoma") + -->
<!--   scale_colour_manual(values = palette.healthy) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), plot.title = element_text(hjust = 0.5)) -->
<!-- ``` -->


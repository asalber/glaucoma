---
title: "Proyecto Glaucoma"
date: "`r Sys.Date()`"
output:
  rmdformats::material:
    smart: false
    highlight: kate
    self_contained: true
    #code_folding: show
    thumbnails: false
    gallery: true
    #fig_width: 4
    #fig_height: 4
    df_print: kable
---

<!-- Autor: Alfredo Sánchez Alberca (asalber@ceu.es) -->

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(digits = 4)
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
```

```{r}
library(dplyr)
library(ggplot2)
library(GGally)
library(gridExtra)
library(ggpubr)
library(DT)
library(psych)
datos <- read.csv(file="datos/datos.csv", header=T, sep=",")
```

# Descripción

## Objetivo

Construir un modelo predictivo del glaucoma a partir de los datos de la tomografía de coherencia óptica mediante técnicas de aprendizaje automático.

## Tipo de estudio

Estudio transversal comparativo. 

# Tamaño muestral

- Pacientes con glaucoma: `r ftable(datos$Glaucoma)[2]`
- Pacientes sin glaucoma: `r ftable(datos$Glaucoma)[1]`

# Variables

```{r}
variables <- read.csv(file="datos/variables.csv", encoding="UTF-8", header=T, sep=",")
datatable(variables, rownames = F, escape=F, class = 'display', options = list(pageLength = 10, dom="ltip", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
variables.Num <- variables[variables$Type=="Num",]
variables.Factors <- variables[variables$Type=="Factor",]
```

# Transformación de datos

Se ha comprobado que el grosor de los anillos depende linealmente de la edad y del área del anillo BMO, por lo que se ha optado por estandarizar los datos aplicando la siguiente transformación: 

$$z_i=(x_i-\bar x-b_{xe}(e_i-\bar e)-b_{xa}(a_i-\bar a))/s_x$$
donde:

- $x_i$ es el valor del individuo $i$ en la variable $x$.
- $\bar x$ es la media de la variable $x$.
- $s_x$ es la desviación típica de la variable $x$.
- $e_i$ es la edad del individuo $i$.
- $\bar e$ es la media de la edad en la base normativa de individuos sanos.
- $b_{xe}$ es la pendiente de la recta de regresión de la variable $x$ sobre la edad.
- $a_i$ es el área del anillo BMO del individuo $i$.
- $\bar a$ es la media del área del anillo BMO en la base normativa de individuos sanos.
- $b_{xa}$ es la pendiente de la recta de regresión de la variable $x$ sobre el área del anillo BMO.
- $z_i$ es el valor estandarizado del individuo $i$ en la variable $x$. 


```{r}
# Normalización de datos
# El grosos de la capa nerviosa depende de la edad y del área del BMO, por lo que hay que aplicar un modelo de regresión para obtener la media y la desviación típica a utilizar en la normalización. 
coef.norm <- read.csv(file="datos/tabla-normalizacion.csv", encoding = "UTF-8", header=T, row.names=1, sep=",")
age.mean <- 52.17
bmo.area.mean <- 1.781
for (i in colnames(datos)[11:ncol(datos)]){
   datos[[i]] <- (datos[[i]]-coef.norm[i,"Media"]-coef.norm[i,"Pendiente.edad"]*(datos$Age-age.mean)-coef.norm[i,"Pendiente.area.bmo"]*(datos$BMO.Area-bmo.area.mean))/coef.norm[i,"Desviacion"]
}
```

# Estadística Descriptiva

## Edad y Género

```{r}
result <- describeBy(datos[,c("Age", "Glaucoma")], datos$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result[-c(3,4),], rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
ggpairs(datos, mapping=aes(color=Glaucoma, alpha=0.5), columns=c("Gender", "Age", "Eye"))
```

## FoBMO.Angle, Displacement y BMO.Area

```{r}
result <- describeBy(datos[,c("FoBMO.Angle", "Displacement", "BMO.Area")], datos$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result, rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
overHist <- function(i){
  p <- ggplot(datos, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5)
  return(p)
}
p <- lapply(c("FoBMO.Angle", "Displacement", "BMO.Area"), overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r}
overBoxplot <- function(i){
  p <- ggplot(datos, aes_string(x="Glaucoma", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
p <- lapply(c("FoBMO.Angle", "Displacement", "BMO.Area"), overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

## BMO

```{r}
datos.BMO <- select(datos, starts_with("BMO"))[-1]
datos.BMO$Glaucoma <- datos$Glaucoma
result <- describeBy(datos.BMO[,-ncol(datos.BMO)], datos.BMO$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result, rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
ggpairs(datos.BMO, mapping=aes(color=Glaucoma, alpha=0.5), columns =  colnames(datos.BMO)[-ncol(datos.BMO)])
```


```{r}
overHist <- function(i){
  p <- ggplot(datos.BMO, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5)
  return(p)
}
p <- lapply(colnames(datos.BMO)[-ncol(datos.BMO)], overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r}
overBoxplot <- function(i){
  p <- ggplot(datos.BMO, aes_string(x="Glaucoma", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
p <- lapply(colnames(datos.BMO)[-ncol(datos.BMO)], overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

## Anillo 3.5

```{r}
datos.3.5 <- select(datos, starts_with("Rim3.5"))
datos.3.5$Glaucoma <- datos$Glaucoma
result <- describeBy(datos.3.5[,-ncol(datos.3.5)], datos.3.5$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result, rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
ggpairs(datos.3.5, mapping=aes(color=Glaucoma, alpha=0.5), columns =  colnames(datos.3.5)[-ncol(datos.3.5)])
```


```{r}
overHist <- function(i){
  p <- ggplot(datos.3.5, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5)
  return(p)
}
p <- lapply(colnames(datos.3.5)[-ncol(datos.3.5)], overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r}
overBoxplot <- function(i){
  p <- ggplot(datos.3.5, aes_string(x="Glaucoma", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
p <- lapply(colnames(datos.3.5)[-ncol(datos.3.5)], overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

## Anillo 4.1

```{r}
datos.4.1 <- select(datos, starts_with("Rim4.1"))
datos.4.1$Glaucoma <- datos$Glaucoma
result <- describeBy(datos.4.1[,-ncol(datos.4.1)], datos.4.1$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result, rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
ggpairs(datos.4.1, mapping=aes(color=Glaucoma, alpha=0.5), columns =  colnames(datos.4.1)[-ncol(datos.4.1)])
```


```{r}
overHist <- function(i){
  p <- ggplot(datos.4.1, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5)
  return(p)
}
p <- lapply(colnames(datos.4.1)[-ncol(datos.4.1)], overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r}
overBoxplot <- function(i){
  p <- ggplot(datos.4.1, aes_string(x="Glaucoma", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
p <- lapply(colnames(datos.4.1)[-ncol(datos.4.1)], overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

## Anillo 4.7

```{r}
datos.4.7 <- select(datos, starts_with("Rim4.7"))
datos.4.7$Glaucoma <- datos$Glaucoma
result <- describeBy(datos.4.7[,-ncol(datos.4.7)], datos.4.7$Glaucoma, mat = T, digits = 4)
result$item <- NULL
result$vars <- NULL
result$range <- NULL
result$mad <- NULL
result$se <- NULL
result$median <- NULL
result$trimmed <- NULL
colnames(result)[1] <- "Glaucoma"
datatable(result, rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```

```{r}
ggpairs(datos.4.7, mapping=aes(color=Glaucoma, alpha=0.5), columns =  colnames(datos.4.7)[-ncol(datos.4.7)])
```


```{r}
overHist <- function(i){
  p <- ggplot(datos.4.7, aes_string(x = i)) + geom_histogram(aes(fill=Glaucoma), colour=I("white"), position="identity", alpha=.5)
  return(p)
}
p <- lapply(colnames(datos.4.7)[-ncol(datos.4.7)], overHist)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

```{r}
overBoxplot <- function(i){
  p <- ggplot(datos.4.7, aes_string(x="Glaucoma", y = i)) + geom_boxplot(aes(fill=Glaucoma))
  return(p)
}
p <- lapply(colnames(datos.4.7)[-ncol(datos.4.7)], overBoxplot)
do.call(ggarrange, c(p, common.legend = TRUE, legend = "top"))
```

# Comparación de medias
## Edad y Área BMO

```{r}
result <- data.frame(t(sapply(datos[c("Age","BMO.Area")], function(x) 
     unlist(t.test(x~datos$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```


## BMO

```{r}
result <- data.frame(t(sapply(datos.BMO[-ncol(datos.BMO)], function(x) 
     unlist(t.test(x~datos$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```


```{r}
result$BMO <- c("G", "NS", "N", "NI", "TI", "T", "TS")
ggplot(result, aes(x = BMO, y = Diferencia.medias)) + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), col="red", width=.2)
```

## Anillo 3.5
```{r}
result <- data.frame(t(sapply(datos.3.5[-ncol(datos.3.5)], function(x) 
     unlist(t.test(x~datos$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```


```{r}
result$Rim3.5 <- c("G", "NS", "N", "NI", "TI", "T", "TS")
ggplot(result, aes(x = Rim3.5, y = Diferencia.medias)) + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), col="red", width=.2)
```

## Anillo 4.1
```{r}
result <- data.frame(t(sapply(datos.4.1[-ncol(datos.4.1)], function(x) 
     unlist(t.test(x~datos$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```


```{r}
result$Rim4.1 <- c("G", "NS", "N", "NI", "TI", "T", "TS")
ggplot(result, aes(x = Rim4.1, y = Diferencia.medias)) + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), col="red", width=.2)
```

## Anillo 4.7
```{r}
result <- data.frame(t(sapply(datos.4.7[-ncol(datos.4.7)], function(x) 
     unlist(t.test(x~datos$Glaucoma)[c("estimate","conf.int", "p.value")]))))
result$difference <- result$estimate.mean.in.group.N-result$estimate.mean.in.group.Y
result <- result[c(1,2,6,3,4,5)]
colnames(result) <- c("Media.Sanos", "Media.Glaucoma","Diferencia.medias", "lim.inf.int.conf", "lim.sup.int.conf", "p-valor")
datatable(format(result,5), rownames = T, escape=F, options = list( paging=F, autoWidth = T, dom="t", language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')))
```


```{r}
result$Rim4.7 <- c("G", "NS", "N", "NI", "TI", "T", "TS")
ggplot(result, aes(x = Rim4.7, y = Diferencia.medias)) + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = lim.sup.int.conf, ymin = lim.inf.int.conf), col="red", width=.2)
```

Se obsevan diferencias muy significativas entre las medias del grosos de todos los anillos de pacientes sanos y con glaucoma. Las diferencias más significativas se dan en el BMO, pero las diferencias mayores se dan en el anillo 3.5. Por sectores las diferencias más significaivas se dan en el BMO global y nasal superior, y las mayores en el anillo 3.5 global y temporal inferior. 


# Glosario

- GCAA: Glaucoma de ángulo abierto
- OCT: Optical coherence tomography (Tomografía de coherencia óptica)
- BMO: Bruch Membrane Opening (Apertura de la membrana de Bruch)
- MRW: Minimum Rim Width (Grosor mínimo del anillo neuroretiniano)
- PRW: Perpendicular Rim Width (Grosor del anillo perpendicular)
- HRW: Horizontal Rim Width (Grosor del anillo horizontal)
- MRA: Minimum Rim Area within the neuroretinal tissue defined by the MRW (Area mínima del anillo neuroretiniano)
- PRA: Perpendicular Rim Area (Area del anillo perpendicular) 
- ONH: Optic Nerve Head (Cabeza del nervio óptico)
- RNFL: Retinal Nerve Fiber Layer (Capa de fibra nerviosa retiniana)
- INL: Inner Nuclear Layer (Capa nuclear interna de la retina)
- IPL: Inner Plexiform Layer (Capa plexiforme interna de la retina)
- OPL: Outer Plexiform Layer (Capa nuclear externa de la retina)
- OPL: Outer Plexiform Layer (Capa plexiforme externa de la retina)
- GCL: Ganglion Cell Layer (Capa de células ganglionares de la retina)
- RPE: Retinal Pigment Epithelium (Epitelio pigmentario de la retina)


